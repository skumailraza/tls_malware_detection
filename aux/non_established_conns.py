#!/usr/bin/env python
# -*- coding: utf-8 -*-
import json
import sys

LOGS_JSON = '../pcap_processing/tls_mal_local.jsons'


def main():
    """    """
    sys.stdout.write('sha2\tpcap_md5\tres_conn_id\testablished\tlast_alert'\
                     '\tsni\tdst_ip\n')
    with open(LOGS_JSON) as fr:
        for pos, en in enumerate(fr):
            # if pos and pos % 1000 == 0:
            #     break
            entry = json.loads(en)
            sha2 = entry[0].replace('.pcap', '')
            pcap_md5 = entry[1]
            if not entry[2]:
                continue
            if 'ssl_dm.log' not in entry[2]:
                continue
            for pos, en in enumerate(entry[2]['ssl.log']):
                if not en['established']:
                    sys.stdout.write('{}\t{}\t{}\t{}\t{}\t{}\t{}:{}\n'.\
                        format(sha2, pcap_md5, en['uid'],
                               en['established'], en['last_alert'],
                               en['server_name'], en['id_resp_h'],
                               en['id_resp_p']))


if __name__ == '__main__':
    main()
